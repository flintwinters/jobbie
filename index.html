<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jobbie</title>
  <style>
    :root{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#e6e6e6;background:#1a1a1a;}
    body{margin:0;padding:18px;background:#1a1a1a;color:#e6e6e6}
    header{display:flex;gap:12px;align-items:center;margin-bottom:14px}
    h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    input[type=file]{display:inline-block;color:#e6e6e6}
    button{padding:6px 10px;border:1px solid #444;background:#2a2a2a;color:#e6e6e6;border-radius:6px;cursor:pointer}
    button:active{transform:translateY(1px)}
    label{font-size:13px}
    .wrap{display:flex;gap:14px}
    .left{flex:1;min-width:280px}
    .table-wrap{background:#202020;border:1px solid #333;border-radius:6px;padding:10px;overflow:auto;max-height:70vh}
    table{border-collapse:collapse;width:100%;min-width:480px;table-layout:fixed}
    th,td{border:1px solid #333;padding:4px 6px;text-align:left;font-size:13px}
    th{background:#2a2a2a;position:sticky;top:0;z-index:2;color:#ccc;position:relative}
    .delete-col-btn{position:absolute;right:4px;top:50%;transform:translateY(-50%);cursor:pointer;color:#ff6b6b;font-size:14px;padding:2px 4px;border-radius:4px;line-height:1;background:rgba(0,0,0,0.1)}
    .delete-col-btn:hover{background:#c14444;color:#fff}
    .th-inner{flex-grow:1;padding:4px 6px}
    td{background:#1e1e1e;color:#e6e6e6}
    td a{color:#80bfff;text-decoration:none}
    #addBtn{font-size:24px;width:32px;height:32px;line-height:0;padding:0;border-radius:50%}
    td.active{outline:2px solid #4da3ff;outline-offset:-2px;background:#2c2c2c}
    .add-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    #newEntryContainer{display:flex;flex:1;gap:6px}
    #newEntryContainer input{flex:1;min-width:0;padding:6px;border:1px solid #444;border-radius:4px;background:#2a2a2a;color:#e6e6e6}
    .add-row input[type=text]{flex:1;padding:6px;border:1px solid #444;border-radius:4px;background:#2a2a2a;color:#e6e6e6}
    .meta{font-size:12px;color:#aaa}
    .small{font-size:12px;color:#aaa}
    .actions{display:flex;gap:8px}
    .download-link{display:inline-block;padding:6px 10px;border-radius:6px;border:1px solid #444;background:#2a2a2a;text-decoration:none;color:#e6e6e6}
    .topbar{display:flex;gap:12px;align-items:center;margin-bottom:10px}
    .dropzone{padding:8px;border:2px dashed #444;border-radius:6px;text-align:center;color:#777}
    .row-number, th:first-child{width:3em;min-width:3em;text-align:center;color:#888;font-size:12px;background:#1e1e1e;padding:4px 0px;box-sizing:content-box}
    .date-column{width:12em;min-width:12em;text-align:center;color:#aaa;font-size:12px;font-family:monospace;background:#1e1e1e}
    .checkbox-column{width:4em;min-width:4em;text-align:center;background:#1e1e1e;padding:0;}
    .checkbox-column label{display:flex;align-items:center;justify-content:center;width:100%;height:100%;cursor:pointer;}
    .checkbox-column input[type="checkbox"]{width:1.2em;height:1.2em;cursor:pointer;}
    .link-cell { display: flex; align-items: center; gap: 6px; }
    .link-cell img { width: 16px; height: 16px; }


    @media (max-width:640px){.wrap{flex-direction:column}}
  </style>
</head>
<body>
  <header>
    <h1>Jobbie Applicator</h1>
  </header>

  <div class="topbar">
    <div class="controls">
    </div>
    <div style="margin-left:auto" class="actions">
      <button id="undoBtn" disabled>Undo</button>
      <button id="redoBtn" disabled>Redo</button>
      <button id="addColumnBtn">Add Column</button>
    </div>
  </div>

  <div class="wrap">
    <div class="left">
      <div class="add-row">
        <div style="flex:1;display:flex;gap:6px;align-items:center">
          <div class="row-number">Top</div>
          <div id="newEntryContainer"></div>
        </div>
        <button id="addBtn">+</button>
      </div>

      <div class="table-wrap" id="tableWrap">
        <table id="table" role="table" aria-label="CSV table" hidden>
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      fetch(`/jobbie/api/csv`)
        .then(response => response.text())
        .then(text => loadCSVText(text))
        .catch(error => console.error('Error fetching CSV:', error));
    });

    // Basic CSV parser that handles quoted fields and commas inside quotes.
    function parseCSV(text){
      const rows = [];
      let cur = '';
      let row = [];
      let i=0, inQuotes=false;
      while(i < text.length){
        const ch = text[i];
        if(inQuotes){
          if(ch === '"'){
            if(text[i+1] === '"') { cur += '"'; i += 2; continue; } // escaped quote
            inQuotes = false; i++; continue;
          } else { cur += ch; i++; continue; }
        }
        if(ch === '"') { inQuotes = true; i++; continue; }
        if(ch === ','){ row.push(cur); cur = ''; i++; continue; }
        if(ch === '\r'){ i++; continue; }
        if(ch === '\n'){ row.push(cur); cur = ''; rows.push(row); row = []; i++; continue; }
        cur += ch; i++;
      }
      // end
      if(cur !== '' || row.length){ row.push(cur); rows.push(row); }
      // handle trailing empty line
      if(rows.length && rows[rows.length-1].length === 1 && rows[rows.length-1][0] === '') rows.pop();
      return rows;
    }

    function toCSV(rows){
      return rows.map(r => r.map(cell => {
        if(cell == null) cell = '';
        const s = String(cell);
        if(s.includes('"') || s.includes(',') || s.includes('\n') || s.includes('\r')){
          return '"' + s.replace(/"/g,'""') + '"';
        }
        return s;
      }).join(',')).join('\n');
    }

    const table = document.getElementById('table');
    const thead = document.getElementById('thead');
    const tbody = document.getElementById('tbody');
    const addBtn = document.getElementById('addBtn');
    const newEntryContainer = document.getElementById('newEntryContainer');
    const addColumnBtn = document.getElementById('addColumnBtn');
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');

    let history = [];
    let historyIndex = -1;

    function saveState(fromUndoRedo = false) {
      // Clear the "redo" history if we're making a new change after undoing
      if (historyIndex < history.length - 1) {
        history = history.slice(0, historyIndex + 1);
      }
      const currentState = { data: JSON.parse(JSON.stringify(data)), header: JSON.parse(JSON.stringify(header)) };
      history.push(currentState);
      historyIndex++;
      updateUndoRedoButtons();

      if (!fromUndoRedo) {
        const csv = toCSV(header ? [header, ...data] : data);
        fetch(`/jobbie/api/csv`, {
          method: 'POST',
          body: csv,
          headers: { 'Content-Type': 'text/csv' }
        }).catch(error => console.error('Error saving CSV:', error));
      }
    }

    function updateUndoRedoButtons() {
      undoBtn.disabled = historyIndex <= 0;
      redoBtn.disabled = historyIndex >= history.length - 1;
    }

    function undo() {
      if (historyIndex > 0) {
        historyIndex--;
        const state = history[historyIndex];
        data = JSON.parse(JSON.stringify(state.data));
        header = JSON.parse(JSON.stringify(state.header));
        render();
        updateUndoRedoButtons();
        saveState(true);
      }
    }

    function redo() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        const state = history[historyIndex];
        data = JSON.parse(JSON.stringify(state.data));
        header = JSON.parse(JSON.stringify(state.header));
        render();
        updateUndoRedoButtons();
        saveState(true);
      }
    }


    undoBtn.addEventListener('click', undo);
    redoBtn.addEventListener('click', redo);

    thead.addEventListener('blur', e => {
      const el = e.target;
      if(el.classList.contains('th-inner')){
        const th = el.parentElement;
        const c = Number(th.dataset.c);
        const newName = el.textContent;
        if(header && header[c] !== newName){
          header[c] = newName;
          saveState();
          render();
        }
      }
    }, true);

    thead.addEventListener('click', e => {
      if(e.target.classList.contains('delete-col-btn')){
        const th = e.target.parentElement;
        const c = Number(th.dataset.c);
        header.splice(c, 1);
        data.forEach(row => row.splice(c, 1));
        saveState();
        render();
      }
    });

    tbody.addEventListener('change', e => {
      if (e.target.type === 'checkbox') {
        const r = Number(e.target.dataset.r);
        const c = header.indexOf('Done');
        data[r][c] = e.target.checked ? 'true' : 'false';
        saveState();
      }
    });

    let data = [];
    let header = null;

    function createCellContent(cellValue) {
      try {
        const url = new URL(cellValue);
        if (url.protocol === 'http:' || url.protocol === 'https:') {
          const container = document.createElement('div');
          container.className = 'link-cell';
          container.dataset.url = cellValue;
          const favicon = document.createElement('img');
          favicon.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; // transparent pixel
          const link = document.createElement('a');
          link.href = cellValue;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.textContent = cellValue;
          container.appendChild(favicon);
          container.appendChild(link);

          fetch(`/jobbie/api/link-preview?url=${encodeURIComponent(cellValue)}`)
            .then(response => response.json())
            .then(preview => {
              console.log('Link preview data:', preview);
              if (preview.favicon) {
                favicon.src = `${BACKEND_URL}${preview.favicon}`;
              link.textContent = preview.title || cellValue;
              }})
            .catch((error) => {
              console.error('Error fetching link preview:', error);
            });

          return container;
        }
      } catch (_) { /* not a URL */ }

      const tdContent = document.createTextNode(cellValue ?? '');
      return tdContent;
    }

    function render(){
      table.hidden = false;
      thead.innerHTML = '';
      tbody.innerHTML = '';

      // determine widest columns count
      const cols = Math.max(...data.map(r=>r.length), header ? header.length : 0);

      // (re)render add row inputs
      newEntryContainer.innerHTML = '';
      for(let c=0;c<cols;c++){
        const columnName = header ? (header[c] ?? `Column ${c+1}`) : `Column ${c+1}`;
        if (columnName === 'Date' || columnName === 'Done') {
          continue; 
        }
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = columnName;
        newEntryContainer.appendChild(input);
      }

      if(header){
        const tr = document.createElement('tr');
        const thRowNum = document.createElement('th'); thRowNum.textContent = '#'; tr.appendChild(thRowNum);
        for(let c=0;c<cols;c++){
          const th = document.createElement('th');
          th.dataset.c = c;

          const inner = document.createElement('div');
          inner.className = 'th-inner';
          inner.textContent = header[c] ?? ('');

          if (header[c] === 'Date') {
            th.classList.add('date-column');
            inner.contentEditable = 'false';
          } else if (header[c] === 'Done') {
            th.classList.add('checkbox-column');
            inner.contentEditable = 'false';
          } else {
            inner.contentEditable = 'true';
            const deleteBtn = document.createElement('span');
            deleteBtn.className = 'delete-col-btn';
            deleteBtn.textContent = 'ðŸ—‘ï¸';
            th.appendChild(deleteBtn);
          }
          
          th.appendChild(inner);
          tr.appendChild(th);
        }
        thead.appendChild(tr);
      } else {
        const tr = document.createElement('tr');
        const thRowNum = document.createElement('th'); thRowNum.textContent = '#'; tr.appendChild(thRowNum);
        for(let c=0;c<cols;c++){
          const th = document.createElement('th'); th.textContent = 'Col ' + (c+1); tr.appendChild(th);
        }
        thead.appendChild(tr);
      }

      // data rows
      for(let r=0;r<data.length;r++){
        const tr = document.createElement('tr');
        const rn = document.createElement('td'); rn.className = 'row-number'; rn.textContent = r+1; tr.appendChild(rn);
        for(let c=0;c<cols;c++){
          const td = document.createElement('td');
          if (header[c] === 'Date') {
            td.classList.add('date-column');
          } else if (header[c] === 'Done') {
            td.classList.add('checkbox-column');
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = data[r][c] === 'true';
            checkbox.dataset.r = r;
            label.appendChild(checkbox);
            td.appendChild(label);
            tr.appendChild(td);
            continue;
          }
          td.appendChild(createCellContent(data[r][c]));
          td.dataset.r = r;
          td.dataset.c = c;
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
    }

    function loadCSVText(text){
      const rows = parseCSV(text);
      if(rows.length === 0) { data = []; header = null; render(); return; }
      header = rows[0];
      data = rows.slice(1);

      let dateColumnIndex = header.indexOf('Date');
      if (dateColumnIndex === -1) {
        header.unshift('Date');
        data.forEach(row => row.unshift(''));
      } else if (dateColumnIndex > 0) {
        const dateHeader = header.splice(dateColumnIndex, 1)[0];
        header.unshift(dateHeader);
        data.forEach(row => {
          const dateCell = row.splice(dateColumnIndex, 1)[0];
          row.unshift(dateCell);
        });
      }

      let doneColumnIndex = header.indexOf('Done');
      if (doneColumnIndex === -1) {
        header.splice(1, 0, 'Done');
        data.forEach(row => row.splice(1, 0, 'false'));
      } else if (doneColumnIndex !== 1) {
        const doneHeader = header.splice(doneColumnIndex, 1)[0];
        header.splice(1, 0, doneHeader);
        data.forEach(row => {
          const doneCell = row.splice(doneColumnIndex, 1)[0];
          row.splice(1, 0, doneCell);
        });
      }
      
      saveState();
      render();
    }

    addBtn.addEventListener('click', ()=>{
      const inputs = Array.from(newEntryContainer.querySelectorAll('input:not([disabled])'));
      const newRow = inputs.map(input => input.value.trim());

      // check if all inputs are empty
      if(newRow.every(val => val === '')){
        alert('Please enter data into at least one cell for the new row.');
        return;
      }

      const date = new Date();
      const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
      newRow.unshift(formattedDate);
      newRow.splice(1, 0, 'false');

      data.unshift(newRow);
      inputs.forEach(input => input.value = '');
      saveState();
      render();
    });



    addColumnBtn.addEventListener('click', ()=>{
      if(!header) header = [];
      const newColName = `Column ${header.length + 1}`;
      header.push(newColName);
      data.forEach(row => row.push(''));
      saveState();
      render();
    });

    newEntryContainer.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addBtn.click();
      }
    });



    
    // --- Spreadsheet QoL hotkeys ---
    let activeCell = null;
    let editingCell = null;
    let originalCellValue = '';
    let isCancelling = false;

    function setActiveCell(td){
      if(activeCell) activeCell.classList.remove('active');
      activeCell = td;
      if(td) {
        td.classList.add('active');
        td.focus();
      }
    }

    tbody.addEventListener('blur', e => {
        const td = e.target;
        if (td.tagName !== 'TD' || !td.hasAttribute('data-r')) return;

        // If we are blurring from an input inside an editing cell, handle saving
        if (editingCell === td && !isCancelling) {
            const input = td.querySelector('input[type="text"]');
            if (input) {
                const r = Number(td.dataset.r);
                const c = Number(td.dataset.c);
                if (!data[r]) data[r] = [];
                data[r][c] = input.value;
                td.innerHTML = '';
                td.appendChild(createCellContent(data[r][c]));
                editingCell = null;
                saveState();
            }
        }
        isCancelling = false;
    }, true);

    document.addEventListener('click', e => {
      if(e.target.tagName === 'TD' && e.target.dataset.c !== undefined && tbody.contains(e.target)){
        setActiveCell(e.target);
      }
    });

    document.addEventListener('keydown', e => {
      if (e.key === 'z' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          undo();
          return;
      }
      if ((e.key === 'y' && (e.ctrlKey || e.metaKey)) || (e.key === 'Z' && (e.ctrlKey || e.metaKey) && e.shiftKey)) {
          e.preventDefault();
          redo();
          return;
      }
      if (e.key === 'Escape' && editingCell) {
          e.preventDefault();
          isCancelling = true;
          editingCell.innerHTML = '';
          editingCell.appendChild(createCellContent(originalCellValue));
          editingCell = null;
          activeCell.focus(); 
          return;
      }

      if (editingCell && e.key === 'Enter') {
          e.preventDefault();
          // Save changes on Enter
          const input = editingCell.querySelector('input[type="text"]');
          const newValue = input ? input.value : originalCellValue;
          const r = Number(editingCell.dataset.r);
          const c = Number(editingCell.dataset.c);
          if (r >= 0) { // Data row
              if(!data[r]) data[r] = [];
              data[r][c] = newValue;
          }
          editingCell.innerHTML = '';
          editingCell.appendChild(createCellContent(newValue));
          editingCell = null;
          activeCell.focus();
          saveState();
          return;
      }

      if (!editingCell && activeCell && e.key === 'Enter') {
          e.preventDefault();
          editingCell = activeCell;
          const linkCell = editingCell.querySelector('.link-cell');
          originalCellValue = linkCell ? linkCell.dataset.url : editingCell.textContent;
          editingCell.innerHTML = '';
          const input = document.createElement('input');
          input.type = 'text';
          input.value = originalCellValue;
          input.style.width = '100%';
          input.style.height = '100%';
          input.style.boxSizing = 'border-box';
          input.style.border = 'none';
          input.style.outline = '2px solid #4da3ff';
          input.style.outlineOffset = '-2px';
          input.style.background = 'transparent';
          input.style.color = 'inherit';
          input.style.font = 'inherit';
          input.style.padding = '0';
          input.style.margin = '0';
          editingCell.appendChild(input);
          input.focus();
          input.select();
          return;
      }

      if (editingCell) return; // Don't navigate while editing
      if (!activeCell) return;

      const r = Number(activeCell.dataset.r);
      const c = Number(activeCell.dataset.c);

      let target = null;
      if(e.key === 'ArrowDown'){ target = tbody.querySelector(`td[data-r="${r+1}"][data-c="${c}"]`); }
      else if(e.key === 'ArrowUp'){ target = tbody.querySelector(`td[data-r="${r-1}"][data-c="${c}"]`); }
      else if(e.key === 'ArrowRight'){ target = tbody.querySelector(`td[data-r="${r}"][data-c="${c+1}"]`); }
      else if(e.key === 'ArrowLeft'){ target = tbody.querySelector(`td[data-r="${r}"][data-c="${c-1}"]`); }

      if(target){ e.preventDefault(); setActiveCell(target); }
    });

    document.addEventListener('copy', e => {
        if (activeCell && !editingCell) {
            e.clipboardData.setData('text/plain', activeCell.textContent);
            e.preventDefault();
        }
    });

    document.addEventListener('paste', e => {
        if (activeCell && !editingCell) {
            e.preventDefault();
            const text = e.clipboardData.getData('text/plain');
            
            const r = Number(activeCell.dataset.r);
            const c = Number(activeCell.dataset.c);
            if (r >= 0) {
                if(!data[r]) data[r] = [];
                data[r][c] = text;
                activeCell.innerHTML = '';
                activeCell.appendChild(createCellContent(text));
                saveState();
            }
        }
    });
  </script>
</body>
</html>
